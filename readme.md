# 作品名称： 惠农资讯--助力乡村振兴



# 1 选题定位

## 1.1 背景

农民对专业农业知识了解的比较浅，同时，通过地方政府进行大面积普及农业知识比较困难，市场信息指导跟不上，农产品种植大多数处于盲目自发行为。在从事种植、养殖、加工中，由于相关技术措施跟不上，加上信息差异，缺乏专家指导，导致农产品收成不如意。还有因技术服务措施跟不上，产业受疫情、病害、技术等冲击，造成农产品滞销。

 

## 1.2 应用场景

为从事农业人民，传递最新的国家政策、提供最新的行情价格，同时，提供专家在线咨询，解答农民的问题，提高农业知识。

 

# 2 需求分析

 

## 2.1 开发环境

硬件环境：i3-8代CUP+8G内存+320G硬盘+20兆校园网

软件环境：Windows 10 + 微信开发者工具 + 微信云开发

 

## 2.2 用户需求分析

由于农民文化技术水平相对落后，市场信息指导跟不上，所以我们小组认为，可以开发一款小程序，专门为从事农业人民，传递最新的国家政策、提供最新的行情价格，同时，提供专家在线咨询，解答农民的问题，提高农业知识。



 

## 2.3 功能需求分析

 

### 2.3.1功能模块

1.首页展示模块

2.文章详情模块

3.问答模块

4.采购模块

5.登录注册模块

6.个人信息模块

7.智能客服模块

 

### 2.3.2功能描述

1.首页展示模块

用户可以查看最新资讯、最新行情、热门文章等。

2.文章详情模块

用户可以进入文章详情，查看文章具体内容

3.问答模块

用户可以进入问答模块，找对对应专家，向专家进行在线咨询

4.采购模块

用户进入采购模块，可以查看最新的爆款商品

5.登录注册模块

用户可以进行登录，如果没有账号，则可以通过注册获取

6.个人信息模块

 用户可以进入个人信息页面，查看个人信息

7.智能客服模块

 用户可以进入智能客服，客服会为你解答一些疑惑

 

**图1** 首页展示模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image002.jpg)

 

 

**图2**文章详情模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image004.jpg)

 

 

 

 

**图3**问答模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image006.jpg)

 

 

 

 

**图4**采购模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image008.jpg)

 

 

 

**图5**登录注册模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image010.jpg) ![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image012.jpg)

 

 

**图6**个人信息模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image014.jpg)

 

 

**图7**智能客服模块

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image016.jpg)

 

## 2.4 非功能需求分析

### 2.4.1性能值标

通过微信小程序提供的性能面板，得出以下性能数据

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image018.jpg)

微信小程序官方文档中，有评分方法与规则，根据性能评分规则：

1.    首屏时间不超过5秒

2.    渲染时间不超过500ms

对比性能数据，可以看出该小程序，首屏时间、渲染时间都完成较好。

 

### 2.4.2安全性

为了保证用户信息，该小程序中分为两大部分，一部分需要登录后才能查看，一部分则不需要登录就能查看。

当用户未登录，进入需要登录才能查看的页面，则小程序会强制跳转到登录页面。

# 3 产品设计

## 3.1 顶部导航栏

1.    为小程序添加一级页面、二级页面，并且在二级页面中增加返回按钮

2.    将小程序导航栏设计为统一颜色，提高用户沉浸式体验

3. 减少不必要的导航栏标题，提高用户视觉体验

 

 

## 3.2 小程序主体

1. 为小程序按钮统一样式，并且统一文字颜色

2. 与导航栏统一颜色，保证小程序主色调统一

3.    头像部分采用挖空留白设计，使其层次更分明

4. 图片展示使用了轮播图的形式，能够自动为用户展示内容

 

## 3.3 底部导航栏

1. 使用两套文字图标，未激活时与激活时，并且激活图标的样式与小程序主色调保持一致

2.    在底部导航栏中，通过文字+图标的形式，为用户提供便捷的提示

 

## 3.4 交互设计

1.    在文章列表中，提供下拉加载更多和下拉刷新，不仅提高了产品性能，还优化用户交互体验

2.    在底部导航栏中，通过文字+图标的形式，为用户提供便捷的提示

 

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image020.jpg)

 

 

 



# 4 技术实现

## 4.1 技术方案

技术选型：微信小程序原生开发+微信小程序云开发（云数据库、云存储）

开发环境：微信开发者工具

插件：wxParse

第三方接口：天行数据

数据来源：惠农网

## 4.2 总体架构设计图

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image022.jpg)

 

## 4.3 技术亮点

### 4.3.1判断用户是否登录

**说明**：项目需要区分登录用户与为登录用户，所以进入指定页面前需要判断

**实现**：

通过定义全局变量userInfo，来存储用户信息，初始值为null。

当用户登录时，通过获取全局变量userInfo，将数据存储到userInfo中

当用户访问我的页面时（需要登陆才能进入），就在初始化页面钩子函数中做判断：

1. userInfo数据不为null，表示用户已经登录。将userInfo数据获取，并展示到我的页面中

2. userInfo数据为null，表示用户为登录。强制跳转到登录页面，通过wx.getStorage获取本地存储，判断用户曾经登录过：

a)  如果有数据，表示曾经登录过，将数据出入到用户名密码

b)  如果没有数据，表示未登录过

 

 

 

 

 

 

 

 

 

### 4.3.2实现上拉刷新

**说明**：当我们浏览文章时，文章数量可能较大，不可能一次性全部展示，通过懒加载形式，上拉更新下一页文章，但是需要保留上一页。

**实现**：

当用户打开文章时，会加载第一页文章数量

当用户上拉时，会加载第一页和第二页文章数量，依次下去，直到文章加载完

需要用到两个生命周期钩子：onLoad（页面加载）、onReachBottom（页面上拉触底）

1. 初次加载：在onLoad中执行，发起请求，获取第一页文章数

2. 后续加载：在onReachBootom中执行

a)  发起请求，获取 pageNum++ 页文章数

b)  拼接当前页数文章和之前的文章，这里我思考出了三种实现方法：

​     i.   通过数组方法concat，将旧文章数和新文章数进行拼接（前提：新旧文章都是数组）

​    ii.   通过展开运算符，用数组容器，将旧文章和新文章进行拼接（写法更简洁，但是效率不如concat）

   iii.   通过展开运算符与push，arr1.push(...arr2)

​    三个方法的优缺点比较：

1. concat，兼容性高，性能好，不需要转译

​    2. ...是es6出的新语法，简化了写法，代码看上去更简洁，但其实只是做了封装，需要babel转译

​    

​     三个方法的性能比较：

​    1. 在数据量小的时候，三者并无差别

​     2. 数据量大的时候，concat性能远高于其他两种

​     分别用1w、10w、100w做测试，结果如下：

​    ![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image024.jpg)

​    考虑到目前文章数量不大，所以我使用了第二种方式，代码更加简洁。

 

c)  数据请求完，通过获取文章总数，判断当前的文章数是否和文章总数相等（通过arr.length），如果相同则表示，数据请求完了，那么就不发起请求。

3. 加载优化：

a)  增加提示信息（正在加载中、没有更多了）。通过wx:if={{isShow}}与wx:if={{isData}}来判断，

​     i.   调用触底函数将，isShow=true

​    ii.   请求成功，isShow=false

   iii.   当数据加载完时，isData=true

b)  节流。通过节流阀，防止用户短时间调用多次触底函数

​     i.   通过设置isLoading，初始值为true，表示节流阀开启，若为false，表示节流阀关闭

​    ii.   下拉触底函数时，判断节流阀是否打开，如果是打开才执行函数，否则返回false

   iii.   进入函数后，关闭节流阀，在请求成功时才将节流阀打开

​    iv.   这样就实现了，在触底函数被执行时，不会继续执行触底函数

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image026.jpg)

 

### 4.3.3点击文章目录，展示文章详情页

**说明**：在文章目录中，用户可以通过点击文章，跳转到具体的文章详情页

**实现**：一开始我是打算为每一篇文章写一个wxml页面，但是这样会出现大量冗余代码，后期维护很痛苦。因为文章详情页代码结构很相似，可以共用一套wxml页面，但是这样结构很不灵活。那么如何能做到，结构灵活的同时还能精简代码，我想到了通过后台传入html结构的页面，前台通过富文本编辑器展示html。

 

我在微信开发社区，收集了小程序富文本解析方案，主要有两种：

 

1. WxParse：WxParse作为一个应用最为应用最广泛的富文本插件，是首选方案

2. rich-text：rich-text 组件作为官方的富文本组件，也是很多人选择的方案

 

这里我使用WxParse来解析html，实现：

1. 下载WxParse

2. WxParse放到小程序项目的根目录

3. 引入

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image028.jpg)

 

### 4.3.4隐藏button样式

**问题**：使用小程序给我们提供的在线聊天功能，在界面中只能通过按钮来打开，但是由于小程序button的默认样式存在，导致无法给它设置样式，我尝试了清空默认样式，但是还是达不到想要的效果

**解决**：通过为button设置透明，并且大小设置为和view一样大，并覆盖到需要跳转的view中，用户看到的是展示的view，但是点击的是button

 

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image030.jpg)

### 4.3.5实现智能客服对话

**说明**：当用户有疑问，并且在线客服无回复的情况下，用户可以咨询智能客服。

**实现**：需要借助第三方接口实现智能问答。

1. 用户发送数据，将用户发送的数据收集

2.    将数据转发给第三方接口，并接收第三方接口响应的数据

3. 将响应数据回复给用户

4. 使用前需要导入相应知识，才能够准确的回复。

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image032.jpg)

 

### 4.3.6自定义dialog组件

**说明**：由于样式的需要，微信小程序提高的弹窗组件不能满足使用，所以通过自定义组件，开发一个带有确定和取消的dialog弹窗组件

**实现**：根据小程序官方文档开发

1.    创建component文件夹，再右击新建component一个dialog

2.    Dialog需要实现的功能：显示、隐藏、触发取消回调、触发确认回调

3.    Dialog的主体结构：标题、内容、确认按钮、取消按钮

4.    回调方法通过this.triggerEvent，传递自定义事件名称，触发执行对应回调

5.    使用自定义组件前，需要在usingComponents传入自定义组件的名称和路径

6. 在页面中触发自定义组件的回调函数时，把自定义组件的this.triggerEvent后的名称与页面的bind的名字相同，即可完成点击确认或取消执行回调

7. Dialog的显示与隐藏通过wx:if=”{{flag}}”，通过控制flag为true或false，实现dialog的显示与隐藏

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image034.jpg)

 

### 4.3.7缓存用户登录信息

**说明**：小程序有些页面是需要登录才能访问，所以用户需要登录，但是如果用户每次都要登录的话，会特别麻烦。只要登录过的用户，我就通过wx.setStorage将用户登录的账号密码存储到本地指定的缓存中，在缓存中，只要用户不主动删除或空间被系统清理，用户的账号密码会一直存在，减少了用户不必要的输入，提高了用户体验。

**实现**：

1.   在登录页面，当用户进行登录时，在成功回调中进行设置缓存

2.   通过wx.setStorage将用户输入的账号密码存储在kay值为userInfo中

3. 当用户再次进入登录页面时，在onLoad钩子函数中，判断缓存中是否存在，如果存在，则通过wx.getStorage获取data数据，并将数据输出到账号密码输入框中。

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image036.jpg)

### 4.3.8触发事件回到顶部

**说明**：在浏览文章列表时，由于长度太长，导致回到顶部需要重新往上滑，这样对用户的使用体验很差。所以，我为文章列表添加了回到顶部事件，用户可以通过点击右侧小图标，不管浏览到什么位置，都能回到顶部。

**实现**：点击图标回到顶部，实现方法很简单，为了优化用户体验，我对滚动条进行实时监听，只有在页面滚动到高度为一半的时候，才出现图标 

1. 在页面中添加图标，通过fixed定位，将图标固定在指定位置

2. 为图标添加点击事件，当用户点击时，触发事件，将wx.pageScrollTo({scrollTop:0})

3.    对滚动条实时监听，回到顶部的图标默认隐藏，当滚动到页面的目标位置小于视口高度一半时，将回到顶部的图标显示。

![img](https://liuxueji.oss-cn-guangzhou.aliyuncs.com/clip_image038.jpg)